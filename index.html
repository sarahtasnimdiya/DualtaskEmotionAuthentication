<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Realtime Emotion + Authenticity</title>
  <style>
    body {
      background: #111;
      color: #eee;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
      margin: 0;
      font-family: Arial, sans-serif;
    }
    .card {
      padding: 10px;
      background: #222;
      border-radius: 10px;
      text-align: center;
    }
    .video-container {
      position: relative;
      display: inline-block;
    }
    video, canvas {
      border-radius: 8px;
      display: block;
    }
    canvas {
      position: absolute;
      left: 0;
      top: 0;
    }
    .controls {
      margin-top: 10px;
    }
    button {
      margin: 0 5px;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: #444;
      color: #eee;
    }
    button:hover {
      background: #666;
    }
    #status {
      margin-left: 10px;
      font-weight: bold;
      color: #0f0;
    }
    #predictionBox {
      margin-top: 15px;
      padding: 10px;
      border-radius: 8px;
      border: 2px solid #444;
      background: #111;
      width: 300px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="video-container">
      <video id="video" autoplay playsinline width="640" height="480"></video>
      <canvas id="overlay" width="640" height="480"></canvas>
    </div>
    <div class="controls">
      <button id="startBtn">Start</button>
      <button id="stopBtn">Stop</button>
      <span id="status">Idle</span>
    </div>
    <!-- 👇 Predictions -->
    <div id="predictionBox">
      <p><strong>Emotion:</strong> <span id="emotion">N/A</span></p>
      <p><strong>Authenticity:</strong> <span id="authenticity">N/A</span></p>
    </div>
  </div>

  <script>
    const video = document.getElementById("video");
    const overlay = document.getElementById("overlay");
    const ctx = overlay.getContext("2d");

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const statusText = document.getElementById("status");

    const emotionEl = document.getElementById("emotion");
    const authEl = document.getElementById("authenticity");

    let stream, ws, sending = false;

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
        video.srcObject = stream;
        statusText.textContent = "Camera On";
        statusText.style.color = "#0f0";
      } catch (err) {
        console.error("Camera error:", err);
        statusText.textContent = "Camera Error";
        statusText.style.color = "red";
      }
    }

    function startWS() {
      ws = new WebSocket("wss://dualtaskemotionauthentication.onrender.com/ws/predict");

      ws.onopen = () => {
        console.log("✅ WebSocket connected");
        statusText.textContent = "Connected";
      };

      ws.onclose = () => {
        console.log("❌ WebSocket disconnected");
        statusText.textContent = "Disconnected";
        sending = false;
      };

      ws.onerror = (err) => {
        console.error("WebSocket error:", err);
        statusText.textContent = "Error";
      };

      ws.onmessage = (ev) => {
        try {
          const data = JSON.parse(ev.data);
          if (data.error) {
            console.warn("⚠️ Backend:", data.error);
            statusText.textContent = "No face detected";
            return;
          }
          drawOverlay(data);

          // Update prediction box
          emotionEl.textContent = `${data.emotion.label} (${(data.emotion.score*100).toFixed(1)}%)`;
          authEl.textContent = `${data.authenticity.label} (${(data.authenticity.genuine_prob*100).toFixed(1)}%)`;

        } catch (e) {
          console.error("Parse error:", e);
        }
      };
    }

    function capture() {
      const c = document.createElement("canvas");
      c.width = video.videoWidth;
      c.height = video.videoHeight;
      c.getContext("2d").drawImage(video, 0, 0);
      return c.toDataURL("image/jpeg", 0.7);
    }

    async function loop() {
      while (sending && ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ image: capture() }));
        await new Promise(r => setTimeout(r, 200)); // ~5 fps
      }
    }

    function drawOverlay(r) {
      ctx.clearRect(0, 0, overlay.width, overlay.height);

      // ✅ Draw face box if available
      if (r.face_box) {
        ctx.strokeStyle = "lime"; // green box
        ctx.lineWidth = 3;
        ctx.strokeRect(r.face_box.x, r.face_box.y, r.face_box.w, r.face_box.h);
      }
    }

    startBtn.onclick = async () => {
      await startCamera();
      startWS();
      sending = true;
      loop();
      statusText.textContent = "Streaming";
    };

    stopBtn.onclick = () => {
      sending = false;
      if (ws) ws.close();
      if (stream) stream.getTracks().forEach(t => t.stop());
      statusText.textContent = "Stopped";
    };
  </script>
</body>
</html>
